<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è—¥ç‰©éæ•æ¯”å°</title>
<meta name="theme-color" content="#111827"/>
<link rel="manifest" href="./manifest.webmanifest"/>
<style>
:root{--bg:#070a14;--c:#111827;--m:#9ca3af;--t:#e5e7eb;--ok:#10b981;--w:#f59e0b;--r:#ef4444}
*{box-sizing:border-box;margin:0;padding:0}
body{font:15px/1.5 system-ui,-apple-system,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--t)}
.wrap{max-width:620px;margin:0 auto;padding:16px}
h1{font-size:18px;font-weight:800;margin-bottom:3px}
.sub{font-size:12px;color:var(--m);margin-bottom:12px}
.card{background:rgba(17,24,39,.9);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin-bottom:10px}
.ct{font-weight:700;font-size:14px;margin-bottom:8px}
textarea,input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1224;color:var(--t);outline:none;font-size:14px}
textarea{min-height:76px;resize:vertical}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
btn,button{padding:9px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#1f2937;color:var(--t);font-weight:700;font-size:13px;cursor:pointer}
button:active{opacity:.7}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);background:#0b1224;margin:4px 4px 0 0;font-size:13px}
.dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.ok{background:var(--ok)}.w{background:var(--w)}.r{background:var(--r)}
.sm{font-size:12px;color:var(--m);line-height:1.7}
.mn{font-family:ui-monospace,monospace;font-size:12px}
hr{border:none;border-top:1px solid rgba(255,255,255,.07);margin:8px 0}
label{font-size:12px;color:var(--m);display:block;margin-bottom:4px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ’Š è—¥ç‰©éæ•æ¯”å°</h1>
  <div class="sub">è²¼æˆåˆ†ã€è—¥åæˆ–è¨±å¯è­‰å­—è™Ÿ â†’ æ¯”å°ä½ çš„éæ•æ¸…å–®</div>

  <div class="card">
    <label>æˆåˆ† / è—¥åï¼ˆè²¼æ–‡å­—ï¼‰</label>
    <textarea id="text" placeholder="ä¾‹ï¼šSulfamethoxazole&#10;æˆ–ï¼šIbuprofen 400mg/tab&#10;å¯è²¼å¤šè¡Œ"></textarea>
    <div style="height:8px"></div>
    <label>è¨±å¯è­‰å­—è™Ÿï¼ˆé¸å¡«ï¼Œå¯åªè²¼æ•¸å­—ï¼‰</label>
    <input type="text" id="license" placeholder="ä¾‹ï¼šå…§è¡›è—¥è£½å­—ç¬¬010572è™Ÿ  æˆ–  010572"/>
    <div class="row">
      <button onclick="run()" style="background:#374151">â–¶ æ¯”å°</button>
      <button onclick="doClear()">æ¸…ç©º</button>
      <button onclick="doShare()">ğŸ”— è¤‡è£½é€£çµ</button>
    </div>
  </div>

  <div class="card">
    <div class="ct">çµæœ</div>
    <div id="result" class="sm">å°šæœªæ¯”å°ã€‚</div>
  </div>

  <div class="card">
    <div class="ct">æˆ‘çš„éæ•æ¸…å–®</div>
    <div class="sm" style="margin-bottom:8px">åªå­˜æœ¬æ©Ÿï¼Œä¸ä¸Šå‚³ã€‚</div>
    <div class="row">
      <button onclick="doEdit()">âœï¸ ç·¨è¼¯</button>
      <button onclick="doExport()">â¬‡ åŒ¯å‡º</button>
      <button onclick="$('file').click()">â¬† åŒ¯å…¥</button>
      <input id="file" type="file" accept="application/json" style="display:none" onchange="doImport(event)"/>
    </div>
    <div id="ap" class="sm" style="margin-top:8px"></div>
  </div>

  <div class="card sm">
    <div id="disc"></div>
    <hr/>
    ğŸŸ¡ å­—è™ŸæŸ¥ä¸åˆ°æˆåˆ† = æœªé©—è­‰ï¼Œä¸çµ¦ç¶ ç‡ˆ<br/>
    <span style="opacity:.5">è³‡æ–™ä¾†æºï¼šTFDA 43_2 + 36_2 é–‹æ”¾è³‡æ–™é›†</span>
  </div>
</div>

<script>
const SK="allergy_checker_user_data_v2";
const $=id=>document.getElementById(id);
function esc(s){return(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[c])}
function nm(s){return(s||"").toLowerCase().replace(/\([^\)]*\)/g," ").replace(/[\[\]{}]/g," ").replace(/\bmg\b|\bml\b|\btab\b|\bcap\b|\bamp\b/gi," ").replace(/[+;,\/]/g," ").replace(/[^a-z0-9\u4e00-\u9fff\s.-]/g," ").replace(/\s+/g," ").trim()}
function toks(s){const t=nm(s);return t?t.split(" ").filter(Boolean):[]}
function nlc(s){return(s||"").replace(/\s+/g,"").trim()}
function dlc(s){const m=(s||"").match(/(\d{5,7})/);return m?m[1]:""}
function rk(v){return v==="high"||v==="bad"?3:v==="medium"||v==="warn"?2:1}
function syn(t,s){return s[(t||"").toLowerCase()]||t}
function expand(ts,bm){const o=[...ts];for(const t of ts){const k=(t||"").toLowerCase();if(bm[k])bm[k].forEach(a=>o.push(String(a).toLowerCase()))}return o}

let BASE={},MAP={},USER={allergies:[]};

async function init(){
  BASE=await fetch("./data.json?v=2").then(r=>r.json()).catch(()=>({}));
  $("disc").textContent=BASE.disclaimer||"";
  // å˜—è©¦è¼‰å…¥ TFDA æˆåˆ†ç´¢å¼•
  MAP=await fetch("./db/license_to_actives.json").then(r=>r.ok?r.json():{}).catch(()=>({}));
  // åˆä½µ data.json è£¡çš„æ‰‹å‹•å°ç…§
  Object.assign(MAP,BASE.license_to_actives||{});
  const raw=localStorage.getItem(SK);
  try{const p=JSON.parse(raw||"{}");USER=Array.isArray(p?.allergies)?p:{allergies:BASE.allergies||[]}}catch{USER={allergies:BASE.allergies||[]}}
  renderAP();
  const p=new URLSearchParams(location.search);
  if(p.get("text"))$("text").value=p.get("text");
  if(p.get("license"))$("license").value=p.get("license");
  if(p.get("text")||p.get("license"))run();
}

function renderAP(){
  $("ap").innerHTML=USER.allergies.map(a=>`â€¢ ${esc(a.value)}${a.note?` <span style="opacity:.6">(${esc(a.note)})</span>`:""}`).join("<br>")||"ï¼ˆç©ºï¼‰";
}

function run(){
  const rawT=$("text").value||"",rawL=$("license").value||"";
  const lf=nlc(rawL),ld=dlc(rawL);

  // æŸ¥å­—è™Ÿâ†’æˆåˆ†
  const entry=(lf&&MAP[lf])||(ld&&MAP[ld])||null;
  const acts=Array.isArray(entry?.actives)?entry.actives:(Array.isArray(entry)?entry:[]);
  const verified=!!(lf||ld)&&acts.length>0;
  let vwhy="";
  if(lf||ld){if(!acts.length)vwhy="å­—è™ŸæŸ¥ä¸åˆ°æˆåˆ†ï¼ˆæœªæ”¶éŒ„ï¼‰"}
  else if(rawT){vwhy="åƒ…è¼¸å…¥æ–‡å­—ï¼Œæœªé€£å‹•å®˜æ–¹å­—è™Ÿæˆåˆ†"}
  else{vwhy="æœªè¼¸å…¥ä»»ä½•è³‡æ–™"}

  const vok=verified;
  const allToks=toks(rawT+" "+acts.join(" "));
  const {dh,gh}=match(allToks);

  const worst=Math.max(...gh.map(g=>rk(g.severity)),...(dh.length?[3]:[1]));
  let st="w",stxt="ğŸŸ¡ æœªå‘½ä¸­ï¼ˆæœªé©—è­‰ï¼‰";
  if(worst>=3){st="r";stxt="ğŸ”´ é«˜é¢¨éšªå‘½ä¸­"}
  else if(worst===2){st="w";stxt="ğŸŸ¡ å¯èƒ½ç›¸é—œ"}
  else if(vok){st="ok";stxt="ğŸŸ¢ å·²é©—è­‰æœªå‘½ä¸­"}

  let h=`<div class="pill"><span class="dot ${st}"></span><b>${esc(stxt)}</b></div>`;
  if(!vok&&worst<3&&vwhy)h+=`<div class="sm" style="margin-top:6px">åŸå› ï¼š${esc(vwhy)}</div>`;
  h+="<hr>";

  if(gh.length){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:4px">æ—ç¾¤å‘½ä¸­</div>`;
    [...gh].sort((a,b)=>rk(b.severity)-rk(a.severity)).forEach(g=>{
      const s=rk(g.severity)>=3?"r":"w";
      h+=`<div class="pill"><span class="dot ${s}"></span>${esc(g.name)}<span class="mn"> ï¼ˆ${esc(g.hit.join(", "))}ï¼‰</span></div>`;
    });
    h+="<hr>";
  }
  if(dh.length){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:4px">ç›´æ¥å‘½ä¸­</div>`;
    dh.forEach(d=>h+=`<div class="pill"><span class="dot r"></span>${esc(d.value)}${d.note?` <span class="sm">(${esc(d.note)})</span>`:""}</div>`);
    h+="<hr>";
  }

  // è¨ºæ–·è³‡è¨Š
  h+=`<div class="mn" style="opacity:.5;line-height:2">`;
  h+=`è—¥åï¼š${esc(rawT||"â€”")}<br>`;
  h+=`å­—è™Ÿï¼š${esc(rawL||"â€”")}<br>`;
  h+=`ç”±å­—è™Ÿå–å¾—æˆåˆ†ï¼š${esc(acts.length?acts.join(", "):"ï¼ˆç„¡ï¼‰")}`;
  if(entry?.name_zh)h+=`<br>å“åï¼š${esc(entry.name_zh)}`;
  h+=`</div>`;

  $("result").innerHTML=h;
}

function match(tokList){
  const s=BASE.synonyms||{},bm=BASE.brand_to_actives||{};
  const nt=tokList.map(t=>syn(t,s));
  const ex=expand(nt,bm).map(t=>syn(t,s));
  const ts=new Set(ex);
  const dh=[],seen=new Set();
  for(const a of USER.allergies){
    const v=syn(nm(a.value),s);
    if(!v)continue;
    if(ts.has(v)){const k=v+"::"+a.value;if(!seen.has(k)){seen.add(k);dh.push({value:a.value,note:a.note||""})}}
  }
  for(const a of USER.allergies){
    const av=(a.value||"").trim();
    if(av.length>=2&&/[\u4e00-\u9fff]/.test(av)&&ex.join(" ").includes(nm(av))){
      const k=nm(av)+"::"+av;if(!seen.has(k)){seen.add(k);dh.push({value:av,note:a.note||""})}
    }
  }
  const gh=[];
  for(const g of(BASE.groups||[])){
    const hit=(g.members||[]).filter(m=>ts.has(String(m).toLowerCase()));
    if(hit.length)gh.push({name:g.name,severity:g.severity||"warn",hit});
  }
  return{dh,gh};
}

function doClear(){$("text").value="";$("license").value="";$("result").innerHTML="å·²æ¸…ç©ºã€‚";history.replaceState(null,"",location.pathname)}
async function doShare(){
  const u=new URL(location.href);
  if($("text").value)u.searchParams.set("text",$("text").value);else u.searchParams.delete("text");
  if($("license").value)u.searchParams.set("license",$("license").value);else u.searchParams.delete("license");
  try{await navigator.clipboard.writeText(u.toString());alert("âœ… å·²è¤‡è£½é€£çµ")}catch{prompt("è¤‡è£½é€£çµï¼š",u.toString())}
}
function doEdit(){
  const next=prompt("ä»¥ JSON ç·¨è¼¯éæ•æ¸…å–®ï¼š",JSON.stringify(USER.allergies,null,2));
  if(!next)return;
  try{
    const p=JSON.parse(next);
    if(!Array.isArray(p))throw 0;
    USER.allergies=p.filter(x=>x?.value).map(x=>({type:x.type||"active",value:x.value.trim(),note:x.note||""})).filter(x=>x.value);
    localStorage.setItem(SK,JSON.stringify(USER));
    renderAP();alert("âœ… å·²æ›´æ–°ï¼ˆåªå­˜æœ¬æ©Ÿï¼‰");
  }catch{alert("JSON æ ¼å¼éŒ¯èª¤ï¼Œæœªæ›´æ–°")}
}
function doExport(){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([JSON.stringify(USER.allergies,null,2)],{type:"application/json"}));
  a.download="my_allergies.json";document.body.appendChild(a);a.click();a.remove();
}
function doImport(e){
  const f=e.target.files?.[0];if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const p=JSON.parse(r.result);if(!Array.isArray(p))throw 0;
      USER.allergies=p.filter(x=>x?.value).map(x=>({type:x.type||"active",value:x.value.trim(),note:x.note||""})).filter(x=>x.value);
      localStorage.setItem(SK,JSON.stringify(USER));renderAP();alert("âœ… åŒ¯å…¥å®Œæˆ");
    }catch{alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸æ­£ç¢º")}
  };
  r.readAsText(f);e.target.value="";
}

init();
</script>
</body>
</html>
